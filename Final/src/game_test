package taja.game;

import java.awt.Canvas;
import java.awt.Color;
import java.awt.Font;
import java.awt.FontMetrics;
import java.awt.Graphics;
import java.awt.TextField;
import java.util.Vector;

import javax.swing.JFrame;;
 
class game_test extends JFrame {
    
    final int FRAME_WIDTH = 800;
    final int FRAME_HEIGHT = 600;
     
    final int SCREEN_WIDTH;
    final int SCREEN_HEIGHT;
     
    int speed = 700; // 단어가 떨어지는 속도
    int interval = 2 * 1000; // 새로운 단어가 나오는 간격
     
    int score = 0;
    int life = 3;
    int curLevel = 0;
    final int MAX_LEVEL;
     
    boolean isPlaying = false;
     
    WordGenerator wg = null; // 단어를 생성하는 쓰레드
    WordDropper wm = null; // 단어를 떨어뜨리는 쓰레드
     
    FontMetrics fm; // 화면에서의 글자 길이를 구하는데 사용
    ThreadGroup virusGrp = new ThreadGroup("virus"); // 바이러스 쓰레드들의 그룹
     
    String[][] data = { 
            { "java", "swing", "import", "println", "Vector", "Thread","GridLayout", "int", "repaint", "boolean", "private", "event"},
            { "java", "swing", "import", "println", "Vector", "Thread","GridLayout", "int", "repaint", "boolean", "private", "event"},
            { "javax", "util", "new", "Panel", "Label", "String", "BorderLayout", "float", "this", "true", "North", "color"},
            { "javax", "util", "new", "Panel", "Label", "String", "BorderLayout", "float", "this", "true", "North", "color" }
        };
  
    // Level(int speed, int interval, int levelUpScore, String[] data) 
    final Level[] LEVEL = { new Level(500, 2000, 1000, data[0]), 
                            new Level(250, 1500, 2000, data[1]),
                            new Level(120, 1000, 3000, data[2]), 
                            new Level(100, 500, 4000, data[3]), };
     
    Vector words = new Vector();
     
    TextField tf = new TextField();
    MyCanvas screen = new MyCanvas();
     
    game_test() {
        this("자바 게임");
    }
     
    game_test(String title) {
        super(title);
        
     
     
       
        add(screen, "Center");
        add(tf, "South");
     
        setBounds(500, 200, FRAME_WIDTH, FRAME_HEIGHT); 
        setResizable(false); // 크기조절 불가능
        setVisible(true); // 프레임을 보여줌
     
        SCREEN_WIDTH = screen.getWidth();
        SCREEN_HEIGHT = screen.getHeight();
        MAX_LEVEL = LEVEL.length - 1; 
     
        fm = getFontMetrics(getFont());
    }
     
    public void repaint() {
        super.repaint();
        screen.repaint();
    }
     
    public void delay(int millis) {
        try {
            Thread.sleep(millis);
        } catch (Exception e) {
        }
    }
     
    // 게임이 시작됨
    public void start() {
     
        isPlaying = true; // isPlaying은 life와 
     
        wg = new WordGenerator();
        wg.start();
     
        wm = new WordDropper();
        wm.start();
    }

     
 
     
    // 출력되는 title의 정보
    public void showTitle(String title, int time) {
        Graphics g = screen.getGraphics();
     
        Font titleFont = new Font("Serif", Font.BOLD, 20);
        g.setFont(titleFont);
     
        FontMetrics fm = getFontMetrics(titleFont);
        int width = fm.stringWidth(title);
     
        g.drawString(title, (SCREEN_WIDTH - width) / 2, SCREEN_HEIGHT / 2);
        delay(time);
    }
     
    
    class WordDropper extends Thread {
    	
        public void run() {
            outer: while (isPlaying) { // life가 0이하가 되면 break outer;됨
                delay(speed);
                for (int i = 0; i < words.size(); i++) {
                    Word tmp = (Word) words.get(i);
     
                    tmp.y += tmp.step;
     
                    // 화면 최하단에 도달했을때
                    // 단어는 remove되고
                    // Life가 감소한다
                    if (tmp.y >= SCREEN_HEIGHT) {
                        tmp.y = SCREEN_HEIGHT;
                        words.remove(tmp);
                        life--;
                        
                        break;
                    }
     
                    // life가 0 이하가 되면 
                    // while문을 빠져 나감
                    if (life <= 0) {
                        isPlaying = false;
                        showTitle("Game Over", 0);
     
                        break outer;
                    }
                } 
     
                repaint(); // AWT안에 구현되어 있기 때문에 Frame을 상속받으면 바로 사용 가능
                           // update()메소드를 자동호출
            }
        } 
    }
    
    class WordGenerator extends Thread {
        public void run() {
            while (isPlaying) {
                String[] data = LEVEL[2].data; 
                
                int rand = (int) (Math.random() * data.length);
                
                // 약 10번에 한번 꼴로 바이러스를 생성한다.
                boolean isVirus = ((int) (Math.random() * 10) + 1) / 10 != 0;
     
                Word word = new Word(data[rand], isVirus);
                words.add(word); 
                delay(interval);
            }
        } // end of run()
    }
    
    class Word {
        String word = "";
        int x = 0;
        int y = 0;
        int step = 5;
     
        Color color = Color.BLACK;
        boolean isVirus = false;
     
        Word(String word) {
            this(word, 10, false);
        }
     
        Word(String word, boolean isVirus) {
            this(word, 10, isVirus);
        }
     
        Word(String word, int step, boolean isVirus) {
            this.word = word;
            this.step = step;
            this.isVirus = isVirus;
     
            if (isVirus)
                color = Color.RED;
     
            int strWidth = fm.stringWidth(word);
     
            x = (int) (Math.random() * SCREEN_WIDTH);
     
            if (x + strWidth >= SCREEN_WIDTH)
                x = SCREEN_WIDTH - strWidth;
        }
     
        public String toString() {
            return word;
        }
    }
    
    class VirusThread extends Thread {
        public VirusThread(ThreadGroup group, String name) {
            super(group, name);
        }
     
        public void run() {
            int rand = (int) (Math.random() * 5);
     
            int virusTime = 10 * 1000; // 바이러스 동작시간을 10초로 설정한다.
     
            switch (rand) {
            case 0:
                speed = speed / 2;
                break;
            case 1:
                interval = interval / 2;
                break;
            case 2:
                speed = speed * 2;
                break;
            case 3:
                interval = interval * 2;
                break;
            case 4:
                words.clear();
                break;
            }
     
            delay(virusTime);
     
            
            speed = LEVEL[curLevel].speed;
            interval = LEVEL[curLevel].interval;
        }
    }
    
    class MyCanvas extends Canvas {
        public void clear() {
            Graphics g = getGraphics();
            g.clearRect(0, 0, FRAME_WIDTH, FRAME_HEIGHT);
        }
     
        public void paint(Graphics g) {
            clear();
     
            for (int i = 0; i < words.size(); i++) {
                Word tmp = (Word) words.get(i);
                g.setColor(tmp.color);
                g.drawString(tmp.word, tmp.x, tmp.y);
            }
        }
    }
    
    class Level {
        int speed;
        int interval;
        int levelUpScore;
        String[] data;
     
        Level(int speed, int interval, int levelUpScore, String[] data) {
            this.speed = speed;
            this.interval = interval;
            this.levelUpScore = levelUpScore;
            this.data = data;
        }
    } 
    

    
    public static void main(String[] args) {
    	game_test game = new game_test(); 
    	game.start();                            
    } 
}
